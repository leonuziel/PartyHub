{
  "metadata": {
    "gameId": "kahoot-clone",
    "title": "Kahoot Clone",
    "description": "A fast-paced trivia game using the new component system.",
    "minPlayers": 1,
    "maxPlayers": 8,
    "artUrl": "/game-art/quizclash.png"
  },
  "gameData": {
    "questions": [
      {
        "questionText": "What is the chemical symbol for gold?",
        "correctAnswer": "Au",
        "options": [ "Ag", "Go", "Gd", "Au" ]
      },
      {
        "questionText": "Which planet is known as the Red Planet?",
        "correctAnswer": "Mars",
        "options": [ "Jupiter", "Venus", "Saturn", "Mars" ]
      },
      {
        "questionText": "What is the most abundant gas in Earth's atmosphere?",
        "correctAnswer": "Nitrogen",
        "options": [ "Oxygen", "Carbon Dioxide", "Argon", "Nitrogen" ]
      }
    ]
  },
  "initialGameState": {
    "currentQuestionIndex": -1,
    "totalRounds": 3,
    "currentQuestion": null,
    "shuffledAnswers": [],
    "winner": null,
    "topThreePlayers": [],
    "timerStart": null,
    "playersAnswered": 0,
    "answerStats": {},
    "leaderboard": []
  },
  "playerAttributes": {
    "score": 0,
    "currentAnswer": null,
    "submittedAt": null,
    "lastScoreGained": 0,
    "rank": 0,
    "previousRank": 0,
    "streak": 0
  },
  "actions": {
    "goToNextQuestion": [
      { "function": "incrementProperty", "args": [ "currentQuestionIndex" ] },
      { "function": "setProperty", "args": [ "playersAnswered", 0 ] },
      { "function": "setProperty", "args": [ "currentQuestion", "{{gameData.questions[gameState.currentQuestionIndex]}}" ] },
      { "function": "setProperty", "args": [ "shuffledAnswers", "{{gameState.currentQuestion.options}}" ] },
      { "function": "shuffleArray", "args": [ "shuffledAnswers" ] }
    ],
    "recordPlayerAnswer": [
      { "function": "setProperty", "args": [ "playerAttributes.{{actorId}}.currentAnswer", "{{payload.text}}" ] },
      { "function": "setProperty", "args": [ "playerAttributes.{{actorId}}.submittedAt", "{{Date.now()}}" ] },
      { "function": "incrementProperty", "args": [ "playersAnswered" ] }
    ],
    "calculateScores": [
      { "function": "setProperty", "args": [ "playerAttributes.{{player.id}}.lastScoreGained", 0 ] },
      {
        "condition": "{{player.currentAnswer === gameState.currentQuestion.correctAnswer}}",
        "function": "setProperty",
        "args": [
          "playerAttributes.{{player.id}}.lastScoreGained",
          "{{ Math.round((1 - ( (player.submittedAt - gameState.timerStart) / 10000)) * 500) + 500 }}"
        ]
      },
      { "function": "incrementProperty", "args": [ "playerAttributes.{{player.id}}.score", "{{player.lastScoreGained}}" ] }
    ],
    "updateStreaks": [
      {
        "condition": "{{player.currentAnswer === gameState.currentQuestion.correctAnswer}}",
        "function": "incrementProperty",
        "args": [ "playerAttributes.{{player.id}}.streak" ]
      },
      {
        "condition": "{{player.currentAnswer !== gameState.currentQuestion.correctAnswer}}",
        "function": "setProperty",
        "args": [ "playerAttributes.{{player.id}}.streak", 0 ]
      }
    ],
    "calculateAnswerStats": [
      { "function": "setProperty", "args": [ "answerStats", {} ] },
      {
        "forEachPlayer": {
          "effects": [
            { "function": "incrementProperty", "args": [ "answerStats.{{player.currentAnswer}}", 1 ] }
          ]
        }
      }
    ],
    "updateLeaderboardAndRanks": [
      {
        "forEachPlayer": {
           "effects": [
             { "function": "setProperty", "args": [ "playerAttributes.{{player.id}}.previousRank", "{{player.rank}}" ] }
           ]
        }
      },
      { "function": "setProperty", "args": [ "leaderboard", "{{players.map(p => ({ id: p.id, nickname: p.nickname, score: p.score, streak: p.streak }))}}" ] },
      { "function": "arraySortBy", "args": [ "leaderboard", "score", "desc" ] },
      {
        "forEachPlayer": {
          "effects": [
             { "function": "setProperty", "args": [ "playerAttributes.{{player.id}}.rank", "{{gameState.leaderboard.findIndex(p => p.id === player.id) + 1}}" ] }
          ]
        }
      }
    ],
    "resetPlayerTurnData": [
       {
        "forEachPlayer": {
          "effects": [
             { "function": "setProperty", "args": [ "playerAttributes.{{player.id}}.submittedAt", null ] },
             { "function": "setProperty", "args": [ "playerAttributes.{{player.id}}.currentAnswer", null ] }
          ]
        }
      }
    ],
    "calculateWinner": [
      { "function": "calculateWinner", "args": [] }
    ]
  },
  "initialState": "STARTING",
  "states": {
    "STARTING": {
      "onEnter": [
        { "function": "shuffleArray", "args": [ "gameData.questions" ] },
        { "function": "startTimer", "args": [ 5, { "function": "dispatchEvent", "args": ["timerExpires"] } ] }
      ]
    },
    "ASKING_QUESTION": {
      "onEnter": [
        { "function": "setProperty", "args": [ "timerStart", "{{Date.now()}}" ] },
        { "runAction": "goToNextQuestion" },
        { "function": "startTimer", "args": [ 10, { "function": "dispatchEvent", "args": ["timerExpires"] } ] }
      ]
    },
    "REVEAL_ANSWER": {
      "onEnter": [
        { "forEachPlayer": { "effects": [{ "runAction": "calculateScores" }, { "runAction": "updateStreaks" }] } },
        { "function": "startTimer", "args": [ 5, { "function": "dispatchEvent", "args": ["timerExpires"] } ] }
      ]
    },
    "SHOW_STATS": {
      "onEnter": [
        { "runAction": "calculateAnswerStats" },
        { "function": "startTimer", "args": [ 8, { "function": "dispatchEvent", "args": ["timerExpires"] } ] }
      ]
    },
    "LEADERBOARD": {
        "onEnter": [
            { "runAction": "updateLeaderboardAndRanks" },
            { "runAction": "resetPlayerTurnData" },
            { "function": "startTimer", "args": [ 8, { "function": "dispatchEvent", "args": ["timerExpires"] } ] }
        ]
    },
    "FINISHED": {
      "onEnter": [
        { "runAction": "calculateWinner" }
      ]
    }
  },
  "events": {
    "submitAnswer": {
      "permissions": [ "player" ],
      "effects": [
        { "runAction": "recordPlayerAnswer" },
        { "function": "dispatchEvent", "args": ["playerAnswered"] }
      ]
    },
    "playerAnswered": {
        "permissions": ["server"],
        "effects": [
          {
            "condition": "{{gameState.playersAnswered === players.length}}",
            "function": "cancelTimer"
          },
          {
            "condition": "{{gameState.playersAnswered === players.length}}",
            "function": "dispatchEvent",
            "args": ["allPlayersAnswered"]
          }
        ]
    },
    "allPlayersAnswered": { "permissions": ["server"] },
    "timerExpires": { "permissions": [ "server" ] }
  },
  "transitions": [
    { "from": "STARTING", "to": "ASKING_QUESTION", "event": "timerExpires" },
    { "from": "ASKING_QUESTION", "to": "REVEAL_ANSWER", "event": "timerExpires" },
    { "from": "ASKING_QUESTION", "to": "REVEAL_ANSWER", "event": "allPlayersAnswered" },
    { "from": "REVEAL_ANSWER", "to": "SHOW_STATS", "event": "timerExpires" },
    { "from": "SHOW_STATS", "to": "LEADERBOARD", "event": "timerExpires" },
    { "from": "LEADERBOARD", "to": "ASKING_QUESTION", "event": "timerExpires", "condition": "{{gameState.currentQuestionIndex < gameState.totalRounds - 1}}" },
    { "from": "LEADERBOARD", "to": "FINISHED", "event": "timerExpires", "condition": "{{gameState.currentQuestionIndex >= gameState.totalRounds - 1}}" }
  ],
  "ui": {
    "STARTING": {
      "host": {
        "components": [
          { 
            "component": "Stack", 
            "props": { "direction": "vertical", "spacing": 24, "alignItems": "center", "justifyContent": "center" }, 
            "layout": { "alignment": "Center", "height": "hug", "width": "100%" },
            "children": [
              { "component": "ImageDisplay", "props": { "src": "{{metadata.artUrl}}", "alt": "{{metadata.title}} Logo" }, "layout": { "height": "200px", "width": "200px" } },
              { "component": "TextDisplay", "props": { "text": "{{metadata.title}}", "fontSize": "3.5rem", "fontWeight": "bold" } },
              { "component": "TextDisplay", "props": { "text": "Get ready to clash!", "fontSize": "1.5rem" } },
              { "component": "Timer", "props": { "duration": 5, "type": "countdown" } }
            ]
          }
        ]
      },
      "player": { 
        "components": [ 
          { 
            "component": "Stack", 
            "props": { "direction": "vertical", "spacing": 16, "alignItems": "center" },
            "layout": { "alignment": "Center", "height": "hug" },
            "children": [
              { "component": "TextDisplay", "props": { "text": "Get Ready!", "fontSize": "2rem", "fontWeight": "bold" } },
              { "component": "TextDisplay", "props": { "text": "The game is about to begin." } }
            ]
          } 
        ] 
      }
    },
    "ASKING_QUESTION": {
      "host": {
        "components": [
           { 
             "component": "TextDisplay", 
             "props": { "text": "Question {{gameState.currentQuestionIndex + 1}} / {{gameState.totalRounds}}", "fontSize": "1.2rem" }, 
             "layout": { "alignment": "TopLeft", "height": "hug", "offset": {"top": 20, "left": 20} } 
           },
           { "component": "Timer", "props": { "duration": 10, "type": "progress" }, "layout": { "alignment": "TopCenter", "height": "hug", "width": "fill", "padding": { "left": 100, "right": 100 } } },
           { 
             "component": "TextDisplay", 
             "props": { "text": "{{gameState.playersAnswered}} / {{players.length}}", "fontSize": "1.2rem" }, 
             "layout": { "alignment": "TopRight", "height": "hug", "offset": {"top": 20, "right": 20} } 
           },
           { 
             "component": "TextDisplay", 
             "props": { "text": "{{gameState.currentQuestion.questionText}}", "fontSize": "2.5rem", "fontWeight": "bold", "textAlign": "center" }, 
             "layout": { "alignment": "Center", "height": "hug", "width": "80%"} 
           },
           {
             "component": "Grid",
             "props": { 
                "columns": 2,
                "rows": 2,
                "spacing": 16,
                "children": "{{gameState.shuffledAnswers.map(answer => ({ 'component': 'Button', 'props': { 'text': answer, 'disabled': true, 'variant': 'secondary' } }))}}"
            },
             "layout": { "alignment": "BottomCenter", "height": "hug", "width": "90%", "offset": {"bottom": 20}}
           }
        ]
      },
      "player": [
        { 
          "condition": "{{player.currentAnswer !== null}}", 
          "components": [ 
            { 
              "component": "Stack",
              "props": { "direction": "vertical", "spacing": 16, "alignItems": "center" },
              "layout": { "alignment": "Center", "height": "hug" },
              "children": [
                { "component": "Spinner" },
                { "component": "TextDisplay", "props": { "text": "Answer locked in!", "fontSize": "1.5rem" } },
                { "component": "TextDisplay", "props": { "text": "Waiting for others..." } }
              ]
            } 
          ] 
        },
        { 
          "components": [ 
            { "component": "ChoiceSelector", "props": { "options": "{{gameState.shuffledAnswers.map(answer => ({text: answer}))}}", "layout": "grid", "onSelect": { "action": "submitAnswer" } }, 
              "layout": { "alignment": "Center", "width": "100%", "height": "100%", "padding": {"top": 16, "bottom": 16, "left": 16, "right": 16 } } 
            } 
          ] 
        }
      ]
    },
    "REVEAL_ANSWER": {
      "host": {
        "components": [
          { "component": "TextDisplay", "props": { "text": "The correct answer is...", "fontSize": "2.5rem", "fontWeight": "bold" }, "layout": { "alignment": "Center", "height": "hug" } }
        ]
      },
      "player": {
        "components": [
           { 
             "component": "Stack", 
             "props": { "direction": "vertical", "spacing": 16, "alignItems": "center" }, 
             "layout": { "alignment": "Center", "height": "hug", "width": "80%" },
             "children": [
                  { "component": "TextDisplay", "props": { "text": "{{player.lastScoreGained > 0 ? 'Correct!' : 'Incorrect!'}}", "fontSize": "3rem", "fontWeight": "bold", "color": "{{player.lastScoreGained > 0 ? '#28a745' : '#dc3545'}}" } },
                  { "component": "TextDisplay", "props": { "text": "+{{player.lastScoreGained}}", "fontSize": "2.5rem" }, "layout": { "height": "hug" } },
                  { "component": "TextDisplay", "props": { "text": "Streak: {{player.streak}} {{player.streak > 1 ? 'üî•' : ''}}", "fontSize": "1.2rem" }, "layout": { "height": "hug" } }
              ]
           }
        ]
      }
    },
    "SHOW_STATS": {
        "host": {
            "components": [
                { "component": "TextDisplay", "props": { "text": "{{gameState.currentQuestion.questionText}}", "fontSize": "1.5rem", "textAlign": "center" }, "layout": { "alignment": "TopCenter", "height": "hug", "offset": { "top": 20 }, "width": "80%" } },
                {
                    "component": "Stack",
                    "props": {
                        "direction": "vertical",
                        "spacing": 16,
                        "children": "{{gameState.currentQuestion.options.map(option => ({ 'component': 'Stack', 'props': { 'direction': 'vertical', 'spacing': 8, 'width': '100%' }, 'children': [ { 'component': 'TextDisplay', 'props': { 'text': `${option} (${gameState.answerStats[option] || 0})`, 'fontWeight': option === gameState.currentQuestion.correctAnswer ? 'bold' : 'normal' } }, { 'component': 'Container', 'props': { 'backgroundColor': '#444', 'borderRadius': '5px', 'width': '100%', 'height': '40px' }, 'children': [{ 'component': 'Container', 'props': { 'backgroundColor': option === gameState.currentQuestion.correctAnswer ? '#28a745' : '#8A2BE2', 'height': '100%', 'borderRadius': '5px', 'width': `${ ((gameState.answerStats[option] || 0) / players.length) * 100 }%` } }] } ] }))}}"
                    },
                    "layout": { "alignment": "Center", "width": "70%", "height": "hug" }
                }
            ]
        },
        "player": { 
          "components": [ 
            { 
              "component": "Stack", 
              "props": { "direction": "vertical", "spacing": 16, "alignItems": "center" },
              "layout": { "alignment": "Center", "height": "hug" },
              "children": [
                { "component": "Spinner" },
                { "component": "TextDisplay", "props": { "text": "Tallying the results...", "fontSize": "1.5rem" } }
              ]
            } 
          ] 
        }
    },
    "LEADERBOARD": {
      "host": {
        "components": [
          { "component": "TextDisplay", "props": { "text": "Leaderboard", "fontSize": "3rem", "fontWeight": "bold" }, "layout": { "alignment": "TopCenter", "height": "hug", "offset": {"top": 40} } },
          {
            "component": "ListDisplay",
            "props": {
              "items": "{{gameState.leaderboard}}",
              "renderItem": {
                "component": "Container", 
                "props": { 
                  "display": "flex", "alignItems": "center", "justifyContent": "space-between", "width": "100%", 
                  "padding": "16px", "backgroundColor": "#1C192B", "borderRadius": "8px" 
                },
                "children": [
                  { 
                    "component": "TextDisplay", 
                    "props": { "text": "#{{gameState.leaderboard.findIndex(p => p.id === item.id) + 1}} {{item.nickname}}", "fontSize": "1.5rem", "fontWeight": "bold" } 
                  },
                  { 
                    "component": "Stack", 
                    "props": { "direction": "horizontal", "spacing": 24, "alignItems": "center" }, 
                    "children": [
                      { "component": "TextDisplay", "props": { "text": "{{item.streak > 1 ? 'üî• ' + item.streak : ''}}", "fontSize": "1.5rem" } },
                      { "component": "TextDisplay", "props": { "text": "{{item.score}}", "fontSize": "1.5rem", "fontWeight": "bold" } }
                  ]}
                ]
              }
            },
            "layout": { "alignment": "Center", "width": "60%", "height": "hug" }
          }
        ]
      },
      "player": {
        "components": [
          {
            "component": "Stack", "props": { "direction": "vertical", "spacing": 16, "alignItems": "center" }, "layout": { "alignment": "Center", "height": "hug", "width": "80%" },
            "children": [
              { "component": "TextDisplay", "props": { "text": "Your Rank", "fontSize": "1.5rem", "color": "#aaa" } },
              { "component": "TextDisplay", "props": { "text": "{{player.rank}} / {{players.length}}", "fontSize": "5rem", "fontWeight": "bold" } },
              { 
                "component": "Stack", 
                "props": { "direction": "horizontal", "spacing": 24, "alignItems": "center" }, 
                "children": [
                  { "component": "TextDisplay", "props": { "text": "Score: {{player.score}}", "fontSize": "1.2rem" } },
                  { "component": "TextDisplay", "props": { "text": "{{player.streak > 1 ? 'üî• ' + player.streak : ''}}", "fontSize": "1.2rem" } }
              ]}
            ]
          }
        ]
      }
    },
    "FINISHED": {
      "host": {
        "components": [
           { 
            "component": "Stack", 
            "props": { "direction": "vertical", "spacing": 24, "alignItems": "center", "justifyContent": "center" }, 
            "layout": { "alignment": "Center", "height": "hug", "width": "100%" },
            "children": [
              { "component": "TextDisplay", "props": { "text": "üèÜ WINNER üèÜ", "fontSize": "3.5rem", "fontWeight": "bold", "color": "#FFD700" } },
              { "component": "TextDisplay", "props": { "text": "{{gameState.winner.nickname}}", "fontSize": "2.5rem", "fontWeight": "bold" } },
              { "component": "TextDisplay", "props": { "text": "with {{gameState.winner.score}} points", "fontSize": "1.5rem" } },
              { 
                "component": "ListDisplay", 
                "props": { "items": "{{gameState.topThreePlayers.slice(1)}}", "renderItem": { "component": "TextDisplay", "props": { "text": "{{item.nickname}}: {{item.score}}" } } }, 
                "layout": { "alignment": "Center", "height": "hug", "offset": { "top": 40 } }
              }
            ]
          }
        ]
      },
      "player": {
        "components": [
          {
            "component": "Stack", "props": { "direction": "vertical", "spacing": 16, "alignItems": "center" }, "layout": { "alignment": "Center", "height": "hug", "width": "80%" },
            "children": [
              { "component": "TextDisplay", "props": { "text": "Game Over!", "fontSize": "2rem", "fontWeight": "bold" } },
              { "component": "TextDisplay", "props": { "text": "Your final rank is {{player.rank}} with {{player.score}} points.", "fontSize": "1.2rem", "textAlign": "center" } }
            ]
          }
        ]
      }
    }
  }
}
